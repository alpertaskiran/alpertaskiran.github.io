<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Bayesian Mix Media Model | Another Tech Blog</title>
<meta name="keywords" content="">
<meta name="description" content="#WIP #TODO:images,formating github repo: https://github.com/alpertaskiran/bayesian_mmm
Model This work is based on Jin, Yuxue, et al (2017) in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:
Time series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality.">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="https://alpertaskiran.github.io/posts/mmm/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.dc96e9e0118e5e264a03d68b104df6ae869cfb73c61f5f89dd91aeb16b0d8c03.css" integrity="sha256-3Jbp4BGOXiZKA9aLEE32roac&#43;3PGH1&#43;J3ZGusWsNjAM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://alpertaskiran.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://alpertaskiran.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alpertaskiran.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://alpertaskiran.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://alpertaskiran.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
    </script>
<meta property="og:title" content="Bayesian Mix Media Model" />
<meta property="og:description" content="#WIP #TODO:images,formating github repo: https://github.com/alpertaskiran/bayesian_mmm
Model This work is based on Jin, Yuxue, et al (2017) in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:
Time series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://alpertaskiran.github.io/posts/mmm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-18T16:57:42+02:00" />
<meta property="article:modified_time" content="2023-04-18T16:57:42+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bayesian Mix Media Model"/>
<meta name="twitter:description" content="#WIP #TODO:images,formating github repo: https://github.com/alpertaskiran/bayesian_mmm
Model This work is based on Jin, Yuxue, et al (2017) in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:
Time series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://alpertaskiran.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Bayesian Mix Media Model",
      "item": "https://alpertaskiran.github.io/posts/mmm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bayesian Mix Media Model",
  "name": "Bayesian Mix Media Model",
  "description": "#WIP #TODO:images,formating github repo: https://github.com/alpertaskiran/bayesian_mmm\nModel This work is based on Jin, Yuxue, et al (2017) in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:\nTime series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality.",
  "keywords": [
    
  ],
  "articleBody": "#WIP #TODO:images,formating github repo: https://github.com/alpertaskiran/bayesian_mmm\nModel This work is based on Jin, Yuxue, et al (2017) in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:\nTime series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality. $t = 1 \\dots T$ . There are $M$ media channels in the media mix, and $x_{t,m}$ is the media spend of channel $m$ at week $t$ It is considered a linear model of the form where $\\tau$ is the intercept capturing baseline sales, and $\\epsilon$ capturing noise is assumed to be uncorrelated with other variables and have constant variance. $f$ is the ad stock function: ![[Pasted image 20230417093241.png|center]] Ad stock function takes as input media spends for a given media during L weeks, the retain-rate and the delay of the peak. The delay is the number of periods before the peak effect. The ad stock function is responsible for capturing the temporal effects of diverse advertising channels. $\\alpha_{m}$ representing the retention rate of ad effect and $\\theta_{m}$ represents the delay in the peak effect of the $m$-th channel. $L$ is the maximum time period that delay can incur effect and it is set to be 13.\nSeasonality and Trend Employing Seasonal-Trend decomposition using LOWESS (locally estimated weighted scatterplot smoothing). For log of target value and setting seasonal to 7 results in lowest residual. This supports the need of additive modeling of seasonality and trend. The idea is to make a matrix of Fourier features which get multiplied by a vector of coefficients to to capture the seasonality. Number of order to create fourier pairs will be 7 (14 new features). Trend will be modeled as linear function. This is further supported by a periodogram where drop after bi-monthly can be seen from the figure below.\nLikelihood and Prior distributions The prior distribution represents the beliefs or assumptions you have about the variables before analyzing the data. Starting point for the choice of priors is following the work done by Jin, Yuxue, et al (2017). Parameter optimization is avoided but one can further it using Bayesian model selection criteria.\nSelecting the likelihood function: The likelihood function describes the relationship between the data and the parameters of the model. Choosing an appropriate likelihood function is critical to accurately model the data. $\\alpha \\backsim Beta(3,3)$, $\\theta \\backsim Uniform(0,12)$, $\\gamma \\backsim Laplace(0,1)$ for the fourier coefficient to add certain regularization, $\\tau \\backsim Normal(0,1)$ additionally trend has a coefficient with $~Normal(0,1)$\nI use a $HalfNormal(1)$ distribution for the media coefficients to ensure they are positive. Main model I used for the likelihood function is a StudentT distribution which is robust against outliers as suggested by this[4] with the precision prior parameter $\\nu \\backsim Gamme(15,1)$ It is suggested by [4]] to use MaxAbsScaler which is convenient to use due to transformation while calculation ROAS.\nModel validation Prior predictive checks make use of simulations from the model. Range is limited to but suggesting negative revenue especially in the initial points should be investigated further. Additional data to support initiation could be effective.\nIt is important to validate the model to ensure that it is reliable and accurate. This can be done by by using posterior predictive checks. Posterior predictive checking also allows one to examine the fit of a model to real data. We see that some extreme values can not be captured.\nChannel performance Channel 3 , Channel 7, Channel 6 contributions are highest to revenue. It is followed by Channel 4, Channel 5. Lowest contributions are from Channel 2, Channel 1 (see notebook) Further we observe that delay parameters have high HDI range and fail to converge. This could further improved by using saturation function. We also observe that the Channel 3 (coeff =0.376), Channel 7 (coeff = 320) and Channel 6 (coeff =305 ) has highest average contribution by unit spending. It is followed by Channel 2( coeff = (0.225))\nModel Comparison We can check the difference with respect to using normal distributed likelihood. To evaluate model performance and to measure it we will use Pareto smoothed importance sampling leave-one-out cross-validation (LOO). We see that our initial model performs better.\nFurther diagnostics can be applied by checking residuals of the model. For each MCMC draw of posterior samples of the parameters we should compute autocorrelation of the residuals of the regression model as suggested by[1] Since this is our main model assumption.\nReferences: Jin, Yuxue, et al. “Bayesian methods for media mix modeling with carryover and shape effects.” (2017)\nGelman, Andrew, et al. “Bayesian Workflow.” ArXiv.org, 3 Nov. 2020\nPyMC-Marketing : https://github.com/pymc-labs/pymc-marketing\nMedia effect estimation with pymc: Adstock, saturation \u0026 diminishing returns. Dr. Juan Camilo Orduz. (2022, February 11). Retrieved April 17, 2023, from https://juanitorduz.github.io/pymc_mmm/\n",
  "wordCount" : "821",
  "inLanguage": "en",
  "datePublished": "2023-04-18T16:57:42+02:00",
  "dateModified": "2023-04-18T16:57:42+02:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://alpertaskiran.github.io/posts/mmm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Another Tech Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://alpertaskiran.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://alpertaskiran.github.io/" accesskey="h" title="Another Tech Blog (Alt + H)">Another Tech Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://alpertaskiran.github.io/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://alpertaskiran.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://alpertaskiran.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://alpertaskiran.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://alpertaskiran.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://alpertaskiran.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Bayesian Mix Media Model
    </h1>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#model" aria-label="Model">Model</a></li>
                <li>
                    <a href="#seasonality-and-trend" aria-label="Seasonality and Trend">Seasonality and Trend</a></li>
                <li>
                    <a href="#likelihood-and-prior-distributions" aria-label="Likelihood and Prior distributions">Likelihood and Prior distributions</a></li>
                <li>
                    <a href="#model-validation" aria-label="Model validation">Model validation</a></li>
                <li>
                    <a href="#channel-performance" aria-label="Channel performance">Channel performance</a></li>
                <li>
                    <a href="#model-comparison" aria-label="Model Comparison">Model Comparison</a></li>
                <li>
                    <a href="#references" aria-label="References:">References:</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>#WIP
#TODO:images,formating
github repo: <a href="https://github.com/alpertaskiran/bayesian_mmm">https://github.com/alpertaskiran/bayesian_mmm</a></p>
<h3 id="model">Model<a hidden class="anchor" aria-hidden="true" href="#model">#</a></h3>
<p>This work is based on <a href="https://research.google/pubs/pub46001/">Jin, Yuxue, et al (2017)</a> in which they provided a Bayesian mixed media model with carryover and shape effect. As it is described in the case study I avoided modeling ad stock shape effects with saturation or diminishing returns. For the sake of completeness, I will define the problem:</p>
<p><img loading="lazy" src="https://lh3.googleusercontent.com/rV1UvxY5yob9VpoPAKjuuqJzxpGinvIPoWTuRpiehwmX__b35S-sDXzO9h1US8Md4vXJaSTDcjmeJAWcWXzkYEHB0aAzNuSSTdylE-jjzmqtBbVL2qGwmZfYsC3uCy1VHF8Pw3aWNZhiLCh-7t9yTFo" alt="|left"  />

Time series data with $y$ target variable (revenue), channel spending $x$ and control variables $z$ captures trend and seasonality. $t = 1 \dots T$ . There are $M$ media channels in the media mix, and $x_{t,m}$ is the media spend of channel $m$ at week $t$ It is considered a linear model of the form where $\tau$ is the intercept capturing baseline sales, and $\epsilon$ capturing noise is assumed to be uncorrelated with other variables and have constant variance. $f$ is the ad stock function:
![[Pasted image 20230417093241.png|center]]
<img loading="lazy" src="https://lh5.googleusercontent.com/TRlVRfwJuE7c5W27-EV_kTFXtSgMUSeo2DNs5NeUOjw1mALIsaC1DB9mGrcyiV7vPssDj-vyAAvJ1NMWlt74e6HkHSAzLXKa1jRLGnqYa9_dQhB_ZeDLo4i4RtFf6n7fiaDq6V9pWH3BDJZYVVFcMv8" alt="|right"  />

Ad stock function takes as input media spends for a given media during  L weeks, the retain-rate and the delay of the peak. The delay is the number of periods before the peak effect. The ad stock function is responsible for capturing the temporal effects of diverse advertising channels. $\alpha_{m}$ representing the retention rate of ad effect  and $\theta_{m}$ represents the delay in the peak effect of the $m$-th channel. $L$ is the maximum time period that delay can incur effect and it is set to be 13.</p>
<h3 id="seasonality-and-trend">Seasonality and Trend<a hidden class="anchor" aria-hidden="true" href="#seasonality-and-trend">#</a></h3>
<p>Employing Seasonal-Trend decomposition using LOWESS (locally estimated weighted scatterplot smoothing). For log of target value and setting seasonal to 7 results in lowest residual. This supports the need of additive modeling of seasonality and trend. The idea is to make a matrix of Fourier features which get multiplied by a vector of coefficients to to capture the seasonality. Number of order to create fourier pairs will be 7 (14 new features). Trend will be modeled as linear function.
This is further supported by a periodogram where drop after bi-monthly can be seen from the figure below.</p>
<h3 id="likelihood-and-prior-distributions">Likelihood and Prior distributions<a hidden class="anchor" aria-hidden="true" href="#likelihood-and-prior-distributions">#</a></h3>
<p>The prior distribution represents the beliefs or assumptions you have about the variables before analyzing the data. Starting point for the choice of priors is following the work done by <a href="https://research.google/pubs/pub46001/">Jin, Yuxue, et al (2017)</a>. Parameter optimization is avoided but one can further it using Bayesian model selection criteria.</p>
<p>Selecting the likelihood function: The likelihood function describes the relationship between the data and the parameters of the model. Choosing an appropriate likelihood function is critical to accurately model the data. $\alpha \backsim Beta(3,3)$, $\theta \backsim Uniform(0,12)$, $\gamma \backsim Laplace(0,1)$ for the fourier coefficient to add certain regularization, $\tau \backsim Normal(0,1)$ additionally trend has a coefficient with $~Normal(0,1)$</p>
<p>I use a $HalfNormal(1)$ distribution for the media coefficients to ensure they are positive. Main model I used for the likelihood function is a StudentT distribution which is  robust against outliers as suggested by this[4] with the precision prior parameter $\nu \backsim Gamme(15,1)$ It is suggested by [4]] to use MaxAbsScaler which is convenient to use due to transformation while calculation ROAS.</p>
<h3 id="model-validation">Model validation<a hidden class="anchor" aria-hidden="true" href="#model-validation">#</a></h3>
<p>Prior predictive checks make use of simulations from the model. Range is limited to but suggesting negative revenue especially in the initial points should be investigated further. Additional data to support initiation could be effective.</p>
<p>It is important to validate the model to ensure that it is reliable and accurate. This can be done by by using posterior predictive checks. Posterior predictive checking also allows one to examine the fit of a model to real data. We see that some extreme values can not be captured.</p>
<h3 id="channel-performance">Channel performance<a hidden class="anchor" aria-hidden="true" href="#channel-performance">#</a></h3>
<p>Channel 3 , Channel 7, Channel 6 contributions are highest to revenue. It is followed by Channel 4, Channel 5. Lowest contributions are from Channel 2, Channel 1 (see notebook) Further we observe that delay parameters have high HDI range and fail to converge. This could further improved by using saturation function. We also observe that the Channel 3 (coeff =0.376), Channel 7 (coeff = 320) and Channel 6 (coeff =305 ) has highest average contribution by unit spending. It is followed by Channel 2( coeff = (0.225))</p>
<h3 id="model-comparison">Model Comparison<a hidden class="anchor" aria-hidden="true" href="#model-comparison">#</a></h3>
<p>We can check the difference with respect to using normal distributed likelihood. To evaluate model performance and to measure it we will use Pareto smoothed importance sampling leave-one-out cross-validation (LOO).  We see that our initial model performs better.</p>
<p>Further diagnostics can be applied by checking residuals of the model. For each MCMC draw of posterior samples of the parameters we should compute autocorrelation of the residuals of the regression model as suggested by[1] Since this is our main model assumption.</p>
<h3 id="references">References:<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h3>
<ol>
<li>
<p><a href="https://research.google/pubs/pub46001/">Jin, Yuxue, et al. “Bayesian methods for media mix modeling with carryover and shape effects.” (2017)</a></p>
</li>
<li>
<p><a href="https://arxiv.org/abs/2011.01808">Gelman, Andrew, et al. “Bayesian Workflow.” ArXiv.org, 3 Nov. 2020</a></p>
</li>
<li>
<p>PyMC-Marketing : <a href="https://github.com/pymc-labs/pymc-marketing">https://github.com/pymc-labs/pymc-marketing</a></p>
</li>
<li>
<p>Media effect estimation with pymc: Adstock, saturation &amp; diminishing returns. Dr. Juan Camilo Orduz. (2022, February 11). Retrieved April 17, 2023, from <a href="https://juanitorduz.github.io/pymc_mmm/">https://juanitorduz.github.io/pymc_mmm/</a></p>
</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://alpertaskiran.github.io/posts/llm/">
    <span class="title">Next »</span>
    <br>
    <span>LLM&#39;s Langchain and Prompt engineering</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
